name: Wait for merge
run-name: Waiting for PR merge

on:
  workflow_run:
    workflows: ["File checks"]
    types:
      - completed

jobs:
  wait-for-merge:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Get PR number from triggering workflow
        id: get_pr
        uses: actions/github-script@v7
        with:
          script: |
            // get the PR from the workflow run that triggered this
            const workflow_run = context.payload.workflow_run;
            
            if (workflow_run.event === 'pull_request') {
              const pr = workflow_run.pull_requests[0];
              if (pr) {
                core.setOutput('pr_number', pr.number);
                return;
              }
            }
            
            core.setFailed('Could not determine PR number');
      
      - name: Wait for PR to merge
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.get_pr.outputs.pr_number }};
            const maxAttempts = 60;
            const delayMs = 10000;
            
            for (let i = 0; i < maxAttempts; i++) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              
              console.log(`Attempt ${i + 1}: PR #${prNumber} state=${pr.state}, merged=${pr.merged}`);
              
              if (pr.merged) {
                console.log('âœ“ PR merged successfully');
                return;
              }
              
              if (pr.state === 'closed' && !pr.merged) {
                core.setFailed('PR closed without merging');
                return;
              }
              
              await new Promise(resolve => setTimeout(resolve, delayMs));
            }
            
            core.setFailed('Timeout: PR did not merge within 10 minutes');
